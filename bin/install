#!/bin/bash
#
# Install greghaynes' DotFiles

set -eux
set -o pipefail

DOTFILES_DIR=${DOTFILES_DIR:-}

bin_dir=$(readlink -f $(dirname $0))

function validate_dotfiles_dir {
    [ -f "$1/bin/install" -a "$(head -n 3 $1/bin/install | tail -n 1)" == "# Install greghaynes' DotFiles" ]
}

function ensure_parent_dir {
    mkdir -p $(dirname $1)
}

function ensure_symlink {
    if ! [ -f $2 ]; then
        ln -s $DOTFILES_DIR/$1 $2
    fi
}

function add_dotfile {
    ensure_parent_dir ~/$1
    ensure_symlink $1 ~/$1
}

function add_binfile {
    ensure_parent_dir ~/bin/$1
    ensure_symlink bin/$1 ~/bin/$1
}

# Setup DotFiles repo
if [ -z "$DOTFILES_DIR" ]; then
    if validate_dotfiles_dir $bin_dir/../; then
        DOTFILES_DIR=$(readlink -f $bin_dir/../)
    else
        DOTFILES_DIR="~/Projects/DotFiles"
        mkdir -p $DOTFILES_DIR
        git clone https://github.com/greghaynes/DotFiles $DOTFILES_DIR
    fi
else
    if ! validate_dotfiles_dir $DOTFILES_DIR; then
        echo "ERROR: DOTFILES_DIR is not a valid dotfiles directory."
        exit 1
    fi
fi

if ! [ -d ~/.vim/bundle/Vundle.vim ]; then
    git clone https://github.com/VundleVim/Vundle.vim.git ~/.vim/bundle/Vundle.vim
fi
vim +PluginInstall +qall

if ! [ -f ~/.vim/autoload/pathogen.vim ]; then
    mkdir -p ~/.vim/autoload ~/.vim/bundle && \
        curl -LSso ~/.vim/autoload/pathogen.vim https://tpo.pe/pathogen.vim
fi

if ! [ -d ~/.vim/bundle/vim-colors-solarized ]; then
    git clone git://github.com/altercation/vim-colors-solarized.git ~/.vim/bundle/vim-colors-solarized
fi

if ! [ -d ~/.oh-my-zsh ]; then
    git clone --depth=1 https://github.com/robbyrussell/oh-my-zsh.git ~/.oh-my-zsh
fi

static_dotfiles=".gitconfig
.git-grab-map
.hgrc
.screenrc
.tmux.conf
.vimrc
.Xmodmap
.Xresources
.zshrc
.config/i3/config"

for dotfile in $static_dotfiles; do
    add_dotfile $dotfile
done

bin_files="git-grab"

for binfile in $bin_files; do
    add_binfile $binfile
done

# Set shell to zsh
for shell in /usr/bin/zsh /bin/zsh; do
    if grep -q $shell "/etc/shells"; then
        if [ "$(getent passwd $(whoami) | cut -d: -f7)" != "$shell" ]; then
            chsh $(whoami) -s $shell
        fi
        break
    fi
done
